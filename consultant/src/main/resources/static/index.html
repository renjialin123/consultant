
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¾£è¡Œ-æ‚¨çš„æ™ºèƒ½å‡ºè¡Œç®¡å®¶</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/vue@3.2.31/dist/vue.global.min.js"></script>
    <script type="text/javascript" src="https://webapi.amap.com/maps?v=1.4.15&key=9987e38d14aa093d3589f3102c562245"></script>
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }

        /* æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* è¾“å…¥æ¡†è‡ªé€‚åº”é«˜åº¦ */
        textarea {
            min-height: 24px;
            max-height: 200px;
            transition: height 0.2s;
        }

        /* åŠ è½½åŠ¨ç”» */
        @keyframes pulse {
            0%, 100% {
                opacity: 0.5;
            }
            50% {
                opacity: 1;
            }
        }

        .animate-pulse {
            animation: pulse 1.5s infinite;
        }

        .delay-100 {
            animation-delay: 0.1s;
        }

        .delay-200 {
            animation-delay: 0.2s;
        }

        /* æ‰“å­—æœºæ•ˆæœ */
        .typing-cursor::after {
            content: "|";
            animation: blink 1s step-end infinite;
        }

        @keyframes blink {
            from, to {
                opacity: 1;
            }
            50% {
                opacity: 0;
            }
        }

        /* è±†åŒ…é£æ ¼è®¾è®¡ */
        .sidebar {
            width: 260px;
            background: linear-gradient(180deg, #f8fafc 0%, #f1f5f9 100%);
            border-right: 1px solid #e2e8f0;
        }

        .dark .sidebar {
            background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
            border-right: 1px solid #334155;
        }

        .chat-list-item {
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .chat-list-item:hover {
            background-color: #e2e8f0;
        }

        .dark .chat-list-item:hover {
            background-color: #334155;
        }

        .chat-list-item.active {
            background-color: #dbeafe;
        }

        .dark .chat-list-item.active {
            background-color: #1e3a8a;
        }

        .main-content {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        }

        .dark .main-content {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        }

        .message-user {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border-radius: 18px 4px 18px 18px;
            box-shadow: 0 2px 6px rgba(59, 130, 246, 0.2);
        }

        .dark .message-user {
            box-shadow: 0 2px 6px rgba(37, 99, 235, 0.3);
        }

        .message-assistant {
            background: white;
            border-radius: 4px 18px 18px 18px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
        }

        .dark .message-assistant {
            background: #1e293b;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
            border: 1px solid #334155;
        }

        .input-container {
            background: white;
            border-radius: 24px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
        }

        .dark .input-container {
            background: #1e293b;
            border: 1px solid #334155;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .send-button {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            transition: all 0.2s ease;
        }

        .send-button:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .avatar-assistant {
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
            box-shadow: 0 2px 6px rgba(139, 92, 246, 0.2);
        }

        .avatar-user {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            box-shadow: 0 2px 6px rgba(59, 130, 246, 0.2);
        }

        .welcome-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
        }

        .dark .welcome-card {
            background: #1e293b;
            border: 1px solid #334155;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }

        .feature-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
            border: 1px solid #e2e8f0;
            transition: all 0.2s ease;
        }

        .feature-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
        }

        .dark .feature-card {
            background: #334155;
            border: 1px solid #475569;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .dark .feature-card:hover {
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
        }

        .capability-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        /* è·¯å†µé¢æ¿æ ·å¼ */
        .traffic-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 400px;
            max-width: 90vw;
            z-index: 1000;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            border: 1px solid #e2e8f0;
        }

        .dark .traffic-panel {
            background: #1e293b;
            border: 1px solid #334155;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        /* å¤©æ°”é¢æ¿æ ·å¼ */
        .weather-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 400px;
            max-width: 90vw;
            z-index: 1000;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            border: 1px solid #e2e8f0;
        }

        .dark .weather-panel {
            background: #1e293b;
            border: 1px solid #334155;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        /* å¤©æ°”å›¾æ ‡ */
        .weather-icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        /* åœ°å›¾å®¹å™¨æ ·å¼ */
        #traffic-map-container {
            width: 100%;
            height: 300px;
            border-radius: 8px;
            overflow: hidden;
        }
    </style>
</head>
<body>
<div id="app" class="flex h-screen bg-gray-50">
    <!-- ä¾§è¾¹æ  -->
    <div class="sidebar flex flex-col h-full p-4">
        <div class="flex items-center mb-6">
            <div class="text-xl font-bold bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent">
                <i class="fas fa-compass mr-2"></i>ä¾£è¡Œ
            </div>
        </div>

        <button @click="startNewConversation"
                class="flex items-center justify-center w-full py-3 mb-4 rounded-xl bg-gradient-to-r from-blue-500 to-indigo-500 text-white hover:from-blue-600 hover:to-indigo-600 transition-all">
            <i class="fas fa-plus mr-2"></i>æ–°å»ºå¯¹è¯
        </button>

        <!-- å‡ºè¡Œå·¥å…· -->
        <div class="mb-4">
            <div class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-2 px-2">
                å‡ºè¡Œå·¥å…·
            </div>
            <div class="flex space-x-2 mb-4">
                <button @click="toggleTrafficPanel"
                        :class="['flex-1 flex items-center justify-center py-2 rounded-lg text-sm',
                                showTrafficPanel ? 'bg-blue-500 text-white' : 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300']">
                    <i class="fas fa-traffic-light mr-2"></i>è·¯å†µ
                </button>
                <button @click="toggleWeatherPanel"
                        :class="['flex-1 flex items-center justify-center py-2 rounded-lg text-sm',
                                showWeatherPanel ? 'bg-blue-500 text-white' : 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300']">
                    <i class="fas fa-cloud-sun mr-2"></i>å¤©æ°”
                </button>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto">
            <div class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-2 px-2">
                å†å²å¯¹è¯
            </div>
            <div v-for="(chat, index) in chatHistory" :key="index"
                 @click="loadChat(chat.id)"
                 :class="['chat-list-item p-3 mb-2 cursor-pointer flex items-center',
                         currentChatId === chat.id ? 'active' : '']">
                <div class="w-8 h-8 rounded-lg bg-blue-100 dark:bg-blue-900 flex items-center justify-center mr-3">
                    <i class="fas fa-comment text-blue-500 dark:text-blue-300"></i>
                </div>
                <div class="flex-1 min-w-0">
                    <div class="font-medium text-gray-900 dark:text-gray-100 truncate text-sm">
                        {{ chat.title }}
                    </div>
                    <div class="text-xs text-gray-500 dark:text-gray-400 truncate">
                        {{ chat.preview }}
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-auto pt-4 border-t border-gray-200 dark:border-gray-700">
            <div class="flex items-center p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer"
                 @click="toggleDarkMode">
                <div class="w-8 h-8 rounded-lg bg-gray-100 dark:bg-gray-700 flex items-center justify-center mr-3">
                    <i :class="darkMode ? 'fas fa-moon text-gray-600 dark:text-gray-300' : 'fas fa-sun text-gray-600 dark:text-gray-300'"></i>
                </div>
                <div class="font-medium text-gray-700 dark:text-gray-300">
                    {{ darkMode ? 'æ·±è‰²æ¨¡å¼' : 'æµ…è‰²æ¨¡å¼' }}
                </div>
            </div>
        </div>
    </div>

    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <div class="flex-1 flex flex-col h-full">
        <!-- èŠå¤©å†…å®¹åŒºåŸŸ -->
        <main class="flex-1 overflow-y-auto p-6 main-content" ref="chatContainer">
            <div v-if="messages.length === 0" class="max-w-3xl mx-auto h-full flex flex-col items-center justify-center">
                <div class="welcome-card p-8 w-full max-w-2xl">
                    <div class="text-center mb-8">
                        <div class="w-20 h-20 rounded-2xl bg-gradient-to-r from-blue-500 to-indigo-500 flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-compass text-white text-3xl"></i>
                        </div>
                        <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">ä¾£è¡Œ - æ‚¨çš„æ™ºèƒ½å‡ºè¡Œç®¡å®¶</h1>
                        <p class="text-gray-600 dark:text-gray-300">è§„åˆ’æ‚¨çš„å®Œç¾æ—…ç¨‹ï¼Œå‘ç°ä¸–ç•Œä¹‹ç¾</p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                        <div class="feature-card p-4">
                            <div class="flex items-center mb-3">
                                <div class="capability-icon bg-blue-100 dark:bg-blue-900 text-blue-500 dark:text-blue-300 mr-3">
                                    <i class="fas fa-map-marked-alt"></i>
                                </div>
                                <h3 class="font-semibold text-gray-900 dark:text-white">è·¯çº¿è§„åˆ’</h3>
                            </div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">æ™ºèƒ½æ¨èæœ€ä½³æ—…è¡Œè·¯çº¿ï¼ŒèŠ‚çœæ—¶é—´</p>
                        </div>

                        <div class="feature-card p-4">
                            <div class="flex items-center mb-3">
                                <div class="capability-icon bg-purple-100 dark:bg-purple-900 text-purple-500 dark:text-purple-300 mr-3">
                                    <i class="fas fa-hotel"></i>
                                </div>
                                <h3 class="font-semibold text-gray-900 dark:text-white">é…’åº—æ¨è</h3>
                            </div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">æ ¹æ®é¢„ç®—æ¨èèˆ’é€‚ä½å®¿</p>
                        </div>

                        <div class="feature-card p-4">
                            <div class="flex items-center mb-3">
                                <div class="capability-icon bg-green-100 dark:bg-green-900 text-green-500 dark:text-green-300 mr-3">
                                    <i class="fas fa-utensils"></i>
                                </div>
                                <h3 class="font-semibold text-gray-900 dark:text-white">ç¾é£ŸæŒ‡å—</h3>
                            </div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">å‘ç°å½“åœ°ç‰¹è‰²ç¾é£Ÿå’Œé¤å…</p>
                        </div>

                        <div class="feature-card p-4">
                            <div class="flex items-center mb-3">
                                <div class="capability-icon bg-yellow-100 dark:bg-yellow-900 text-yellow-500 dark:text-yellow-300 mr-3">
                                    <i class="fas fa-cloud-sun"></i>
                                </div>
                                <h3 class="font-semibold text-gray-900 dark:text-white">å¤©æ°”æŸ¥è¯¢</h3>
                            </div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">å®æ—¶å¤©æ°”é¢„æŠ¥ï¼Œå‡ºè¡Œæ— å¿§</p>
                        </div>
                    </div>

                    <div class="text-center">
                        <p class="text-gray-500 dark:text-gray-400 text-sm">
                            <i class="fas fa-lightbulb text-yellow-500 mr-1"></i>
                            æç¤ºï¼šè¯•ç€é—®"æ¨è5å¤©çš„æ—¥æœ¬æ—…è¡Œè·¯çº¿"
                        </p>
                    </div>
                </div>
            </div>

            <div v-else class="max-w-3xl mx-auto">
                <div v-for="(message, index) in messages" :key="index" class="mb-6">
                    <div :class="['flex', message.role === 'user' ? 'justify-end' : 'justify-start']">
                        <div :class="['flex items-start max-w-full', message.role === 'user' ? 'flex-row-reverse' : '']">
                            <div :class="['w-9 h-9 rounded-full flex items-center justify-center flex-shrink-0 mt-1',
                                          message.role === 'user' ? 'avatar-user ml-3' : 'avatar-assistant mr-3']">
                                <i :class="message.role === 'user' ? 'fas fa-user text-white' : 'fas fa-robot text-white'"></i>
                            </div>
                            <div :class="[message.role === 'user' ? 'message-user text-white' : 'message-assistant text-gray-800 dark:text-gray-100', 'px-4 py-3']">
                                <div v-if="message.role === 'assistant' && message.isLoading" class="flex space-x-2">
                                    <div :class="['w-2 h-2 rounded-full bg-gray-400 dark:bg-gray-500', 'animate-pulse']"></div>
                                    <div :class="['w-2 h-2 rounded-full bg-gray-400 dark:bg-gray-500', 'animate-pulse delay-100']"></div>
                                    <div :class="['w-2 h-2 rounded-full bg-gray-400 dark:bg-gray-500', 'animate-pulse delay-200']"></div>
                                </div>
                                <div v-else class="whitespace-pre-wrap">
                                    <span v-for="(char, charIndex) in message.content" :key="charIndex"
                                          :class="{'opacity-0': charIndex >= message.visibleChars, 'fade-in': charIndex < message.visibleChars}">
                                        {{ char }}
                                    </span>
                                    <span v-if="message.isStreaming" class="typing-cursor"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- è¾“å…¥æ¡†åŒºåŸŸ -->
        <footer class="p-4 border-t border-gray-200 dark:border-gray-700">
            <div class="max-w-3xl mx-auto">
                <div class="input-container flex items-end p-2">
                    <textarea
                        v-model="userInput"
                        @keydown.enter.exact.prevent="sendMessage"
                        @keydown.ctrl.enter.exact.prevent="sendMessage"
                        @keydown.esc.exact="stopResponse"
                        placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜... (ä¾‹å¦‚: æ¨è5å¤©çš„æ—¥æœ¬æ—…è¡Œè·¯çº¿)"
                        class="flex-1 py-2 px-4 focus:outline-none resize-none bg-transparent text-gray-900 dark:text-white max-h-32"
                        rows="1"
                        ref="textarea"
                        @input="adjustTextareaHeight"
                    ></textarea>
                    <button
                        @click="isLoading ? stopResponse() : sendMessage()"
                        :disabled="!userInput.trim() && !isLoading"
                        :class="['send-button flex items-center justify-center ml-2',
                                isLoading ? 'bg-gradient-to-r from-red-500 to-orange-500' : '',
                                'disabled:opacity-50 disabled:cursor-not-allowed']"
                    >
                        <i :class="isLoading ? 'fas fa-stop text-white' : 'fas fa-paper-plane text-white'"></i>
                    </button>
                </div>
                <div class="text-xs text-gray-500 dark:text-gray-400 mt-2 text-center">
                    ä¾£è¡Œ - æ‚¨çš„æ™ºèƒ½å‡ºè¡Œç®¡å®¶ Â· æŒ‰ Enter å‘é€ï¼ŒæŒ‰ Ctrl+Enter æ¢è¡Œ
                </div>
            </div>
        </footer>
    </div>

    <!-- è·¯å†µé¢æ¿ -->
    <div v-if="showTrafficPanel" class="traffic-panel">
        <div class="p-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">å®æ—¶è·¯å†µä¿¡æ¯</h3>
                <button @click="showTrafficPanel = false" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div v-if="trafficInfo" class="space-y-4">
                <div class="grid grid-cols-3 gap-4 text-center">
                    <div class="bg-blue-50 dark:bg-blue-900 p-3 rounded-lg">
                        <div class="text-2xl font-bold text-blue-600 dark:text-blue-300">{{ Math.round(trafficInfo.totalDistance/1000) }}km</div>
                        <div class="text-sm text-gray-600 dark:text-gray-300">æ€»è·ç¦»</div>
                    </div>
                    <div class="bg-green-50 dark:bg-green-900 p-3 rounded-lg">
                        <div class="text-2xl font-bold text-green-600 dark:text-green-300">{{ Math.round(trafficInfo.totalDuration/60) }}åˆ†é’Ÿ</div>
                        <div class="text-sm text-gray-600 dark:text-gray-300">é¢„è®¡æ—¶é—´</div>
                    </div>
                    <div class="bg-yellow-50 dark:bg-yellow-900 p-3 rounded-lg">
                        <div class="text-2xl font-bold text-yellow-600 dark:text-yellow-300">Â¥{{ trafficInfo.tolls }}</div>
                        <div class="text-sm text-gray-600 dark:text-gray-300">è¿‡è·¯è´¹</div>
                    </div>
                </div>

                <div id="traffic-map-container"></div>

                <div class="space-y-2 max-h-60 overflow-y-auto">
                    <div v-for="(step, index) in trafficInfo.steps" :key="index"
                         :class="['p-3 rounded-lg border',
                                 step.condition === 'ç•…é€š' ? 'border-green-200 bg-green-50 dark:bg-green-900/30 dark:border-green-800' :
                                 step.condition === 'ç¼“è¡Œ' ? 'border-yellow-200 bg-yellow-50 dark:bg-yellow-900/30 dark:border-yellow-800' :
                                 'border-red-200 bg-red-50 dark:bg-red-900/30 dark:border-red-800']">
                        <div class="flex justify-between">
                            <span class="font-medium text-gray-900 dark:text-white">{{ step.roadName || 'æœªçŸ¥é“è·¯' }}</span>
                            <span :class="['px-2 py-1 rounded text-xs font-medium',
                                          step.condition === 'ç•…é€š' ? 'bg-green-100 text-green-800 dark:bg-green-800/50 dark:text-green-200' :
                                          step.condition === 'ç¼“è¡Œ' ? 'bg-yellow-100 text-yellow-800 dark:bg-yellow-800/50 dark:text-yellow-200' :
                                          'bg-red-100 text-red-800 dark:bg-red-800/50 dark:text-red-200']">
                                {{ step.condition }}
                            </span>
                        </div>
                        <div class="text-sm text-gray-600 dark:text-gray-300 mt-1">
                            {{ step.distance }}ç±³ Â· çº¦{{ Math.round(step.duration/60) }}åˆ†é’Ÿ
                        </div>
                    </div>
                </div>
            </div>

            <div v-else class="text-center py-8 text-gray-500 dark:text-gray-400">
                <i class="fas fa-route fa-2x mb-2"></i>
                <p>æ­£åœ¨è·å–è·¯å†µä¿¡æ¯...</p>
                <button @click="initTrafficDemo" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                    æ¼”ç¤ºè·¯å†µæŸ¥è¯¢
                </button>
            </div>
        </div>
    </div>

    <!-- å¤©æ°”é¢æ¿ -->
    <div v-if="showWeatherPanel" class="weather-panel">
        <div class="p-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">å®æ—¶å¤©æ°”ä¿¡æ¯</h3>
                <button @click="showWeatherPanel = false" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div v-if="weatherInfo" class="space-y-4">
                <div class="text-center p-4 bg-gradient-to-r from-blue-400 to-blue-600 rounded-lg text-white">
                    <div class="text-2xl font-bold">{{ weatherInfo.city }}</div>
                    <div class="weather-icon">
                        <i :class="getWeatherIcon(weatherInfo.weather)"></i>
                    </div>
                    <div class="text-4xl font-bold">{{ weatherInfo.temperature }}Â°C</div>
                    <div class="text-lg">{{ weatherInfo.weather }}</div>
                    <div class="text-sm opacity-80">{{ weatherInfo.winddirection }}é£ {{ weatherInfo.windpower }}çº§</div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-blue-50 dark:bg-blue-900/30 p-3 rounded-lg">
                        <div class="text-sm text-gray-600 dark:text-gray-300">æ¹¿åº¦</div>
                        <div class="text-xl font-bold text-blue-600 dark:text-blue-300">{{ weatherInfo.humidity }}%</div>
                    </div>
                    <div class="bg-yellow-50 dark:bg-yellow-900/30 p-3 rounded-lg">
                        <div class="text-sm text-gray-600 dark:text-gray-300">æ°”å‹</div>
                        <div class="text-xl font-bold text-yellow-600 dark:text-yellow-300">{{ weatherInfo.pressure }} hPa</div>
                    </div>
                </div>

                <div class="bg-gray-50 dark:bg-gray-700 p-3 rounded-lg">
                    <div class="text-sm text-gray-600 dark:text-gray-300 mb-2">æœªæ¥å‡ å¤©é¢„æŠ¥</div>
                    <div class="space-y-2">
                        <div v-for="(forecast, index) in weatherInfo.forecasts" :key="index" class="flex justify-between items-center">
                            <div class="text-gray-900 dark:text-white">{{ forecast.date }}</div>
                            <div class="flex items-center">
                                <i :class="[getWeatherIcon(forecast.dayweather), 'mr-2']"></i>
                                <span class="text-gray-900 dark:text-white">{{ forecast.nighttemp }}Â°/{{ forecast.daytemp }}Â°</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div v-else class="text-center py-8 text-gray-500 dark:text-gray-400">
                <i class="fas fa-cloud-sun fa-2x mb-2"></i>
                <p>æ­£åœ¨è·å–å¤©æ°”ä¿¡æ¯...</p>
                <button @click="initWeatherDemo" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                    æ¼”ç¤ºå¤©æ°”æŸ¥è¯¢
                </button>
                <div class="mt-4">
                    <input v-model="weatherCity" type="text" placeholder="è¾“å…¥åŸå¸‚åç§°"
                           class="w-full px-3 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    <button @click="getWeatherByCity(weatherCity)"
                            class="mt-2 w-full px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">
                        æŸ¥è¯¢å¤©æ°”
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const {createApp, ref, nextTick, onMounted, watch} = Vue;

    createApp({
        setup() {
            const messages = ref([]);
            const userInput = ref('');
            const isLoading = ref(false);
            const chatContainer = ref(null);
            const textarea = ref(null);
            const darkMode = ref(false);
            const chatHistory = ref([
                { id: '1', title: 'æ—¥æœ¬æ—…è¡Œè®¡åˆ’', preview: 'æˆ‘æƒ³å»ä¸œäº¬ã€å¤§é˜ªå’Œäº¬éƒ½...' },
                { id: '2', title: 'æ¬§æ´²åæ—¥æ¸¸', preview: 'æ¨èæ„å¤§åˆ©ã€æ³•å›½å’Œå¾·å›½çš„è¡Œç¨‹...' },
                { id: '3', title: 'æµ·å²›åº¦å‡æ¨è', preview: 'é©¬å°”ä»£å¤«å’Œå·´å˜å²›å“ªä¸ªæ›´é€‚åˆ...' }
            ]);
            const currentChatId = ref('1');

            const memoryId = ref(Date.now().toString());
            let controller = null;
            let typingInterval = null;

            // è·¯å†µç›¸å…³å˜é‡
            const showTrafficPanel = ref(false);
            const trafficInfo = ref(null);
            const mapInstance = ref(null);
            const trafficLayer = ref(null);
            const trafficMonitoring = ref(null);

            // å¤©æ°”ç›¸å…³å˜é‡
            const showWeatherPanel = ref(false);
            const weatherInfo = ref(null);
            const weatherCity = ref('åŒ—äº¬');

            // è°ƒæ•´æ–‡æœ¬åŒºåŸŸé«˜åº¦
            const adjustTextareaHeight = () => {
                const textareaEl = textarea.value;
                textareaEl.style.height = 'auto';
                textareaEl.style.height = `${Math.min(textareaEl.scrollHeight, 200)}px`;
            };

            // æ»šåŠ¨åˆ°åº•éƒ¨
            const scrollToBottom = () => {
                nextTick(() => {
                    if (chatContainer.value) {
                        chatContainer.value.scrollTop = chatContainer.value.scrollHeight;
                    }
                });
            };

            // åˆ‡æ¢æš—é»‘æ¨¡å¼
            const toggleDarkMode = () => {
                darkMode.value = !darkMode.value;
                localStorage.setItem('darkMode', darkMode.value);
            };

            // æ–°å»ºä¼šè¯
            const startNewConversation = () => {
                // æ¸…ç©ºèŠå¤©è®°å½•
                messages.value = [];
                // ç”Ÿæˆæ–°çš„ memoryId
                memoryId.value = Date.now().toString();
                // æ·»åŠ æ¬¢è¿æ¶ˆæ¯
                messages.value.push({
                    role: 'assistant',
                    content: 'æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„å‡ºè¡Œç®¡å®¶å°æ™ºï¼Œå¯ä»¥å¸®æ‚¨è§„åˆ’å®Œç¾çš„æ—…è¡Œè·¯çº¿ã€‚è¯·é—®æ‚¨æƒ³å»å“ªé‡Œæ—…è¡Œï¼Ÿæœ‰ä»€ä¹ˆç‰¹åˆ«çš„éœ€æ±‚å—ï¼Ÿ',
                    isLoading: false,
                    visibleChars: 0,
                    isStreaming: false
                });
                // ç¡®ä¿æ¬¢è¿æ¶ˆæ¯å®Œå…¨å¯è§
                messages.value[0].visibleChars = messages.value[0].content.length;
                // æ»šåŠ¨åˆ°åº•éƒ¨
                scrollToBottom();
                // èšç„¦è¾“å…¥æ¡†
                nextTick(() => {
                    textarea.value.focus();
                });
            };

            // åŠ è½½å†å²å¯¹è¯
            const loadChat = (id) => {
                currentChatId.value = id;
                // è¿™é‡Œåº”è¯¥ä»æœåŠ¡å™¨åŠ è½½å¯¹è¯å†å²
                // æš‚æ—¶æ¨¡æ‹ŸåŠ è½½
                messages.value = [];
                messages.value.push({
                    role: 'assistant',
                    content: 'æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„å‡ºè¡Œç®¡å®¶å°æ™ºï¼Œå¯ä»¥å¸®æ‚¨è§„åˆ’å®Œç¾çš„æ—…è¡Œè·¯çº¿ã€‚è¯·é—®æ‚¨æƒ³å»å“ªé‡Œæ—…è¡Œï¼Ÿæœ‰ä»€ä¹ˆç‰¹åˆ«çš„éœ€æ±‚å—ï¼Ÿ',
                    isLoading: false,
                    visibleChars: 0,
                    isStreaming: false
                });
                messages.value[0].visibleChars = messages.value[0].content.length;
                scrollToBottom();
                nextTick(() => {
                    textarea.value.focus();
                });
            };

            // æ¨¡æ‹Ÿé€å­—æ‰“å°æ•ˆæœ
            const startTypingEffect = (messageIndex) => {
                const message = messages.value[messageIndex];
                if (!message || message.visibleChars >= message.content.length) {
                    clearInterval(typingInterval);
                    typingInterval = null;
                    messages.value[messageIndex].isStreaming = false;
                    return;
                }

                messages.value[messageIndex].visibleChars++;
                scrollToBottom();
            };

            // å‘é€æ¶ˆæ¯
            const sendMessage = async () => {
                if (!userInput.value.trim() || isLoading.value) return;

                // æ£€æŸ¥æ˜¯å¦æ˜¯è·¯å†µæŸ¥è¯¢ç›¸å…³çš„é—®é¢˜
                const trafficKeywords = ['è·¯å†µ', 'äº¤é€šçŠ¶å†µ', 'å µè½¦', 'è·¯çº¿çŠ¶å†µ', 'å®æ—¶è·¯å†µ', 'äº¤é€šæƒ…å†µ'];
                const isTrafficQuery = trafficKeywords.some(keyword =>
                    userInput.value.includes(keyword)
                );

                // æ£€æŸ¥æ˜¯å¦æ˜¯å¤©æ°”æŸ¥è¯¢ç›¸å…³çš„é—®é¢˜
                const weatherKeywords = ['å¤©æ°”', 'æ°”æ¸©', 'æ¸©åº¦', 'é™æ°´', 'é£åŠ›', 'æ°”è±¡'];
                const isWeatherQuery = weatherKeywords.some(keyword =>
                    userInput.value.includes(keyword)
                );

                if (isTrafficQuery) {
                    // å¤„ç†è·¯å†µæŸ¥è¯¢
                    handleTrafficQuery(userInput.value.trim());
                    return;
                }

                if (isWeatherQuery) {
                    // å¤„ç†å¤©æ°”æŸ¥è¯¢
                    handleWeatherQuery(userInput.value.trim());
                    return;
                }

                // ä¸­æ­¢ä¹‹å‰çš„è¯·æ±‚
                if (controller) {
                    controller.abort();
                }
                controller = new AbortController();

                const userMessage = {
                    role: 'user',
                    content: userInput.value.trim(),
                    isLoading: false,
                    visibleChars: userInput.value.trim().length,
                    isStreaming: false
                };

                messages.value.push(userMessage);

                const assistantMessage = {
                    role: 'assistant',
                    content: '',
                    isLoading: true,
                    visibleChars: 0,
                    isStreaming: true
                };

                messages.value.push(assistantMessage);

                userInput.value = '';
                adjustTextareaHeight();
                scrollToBottom();

                isLoading.value = true;

                try {
                    const response = await fetch(`/chat?message=${encodeURIComponent(userMessage.content)}&memoryId=${memoryId.value}`, {
                        signal: controller.signal
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder('utf-8');
                    let buffer = '';
                    let messageIndex = messages.value.length - 1;

                    // å…ˆæ¸…é™¤ä¹‹å‰çš„æ‰“å­—æ•ˆæœ
                    if (typingInterval) {
                        clearInterval(typingInterval);
                        typingInterval = null;
                    }

                    // å¼€å§‹æµå¼å¤„ç†
                    while (true) {
                        const {done, value} = await reader.read();
                        if (done) break;

                        const chunk = decoder.decode(value, {stream: true});
                        buffer += chunk;

                        // ç›´æ¥æ›´æ–°å†…å®¹
                        messages.value[messageIndex].content = buffer;
                        messages.value[messageIndex].isLoading = false;

                        // å¯åŠ¨æ‰“å­—æ•ˆæœ
                        if (!typingInterval) {
                            typingInterval = setInterval(() => {
                                startTypingEffect(messageIndex);
                            }, 20); // è°ƒæ•´è¿™ä¸ªå€¼å¯ä»¥æ”¹å˜æ‰“å­—é€Ÿåº¦
                        }

                        scrollToBottom();
                    }

                } catch (error) {
                    if (error.name === 'AbortError') {
                        console.log('è¯·æ±‚è¢«ç”¨æˆ·ä¸­æ­¢');
                    } else {
                        console.error('è¯·æ±‚å‡ºé”™:', error);
                        const lastMessage = messages.value[messages.value.length - 1];
                        lastMessage.content = 'æŠ±æ­‰ï¼Œè¯·æ±‚è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯: ' + error.message;
                        lastMessage.visibleChars = lastMessage.content.length;
                    }
                } finally {
                    const lastMessage = messages.value[messages.value.length - 1];
                    lastMessage.isLoading = false;
                    lastMessage.isStreaming = false;

                    // ç¡®ä¿æ‰€æœ‰å­—ç¬¦éƒ½å¯è§
                    if (lastMessage.visibleChars < lastMessage.content.length) {
                        lastMessage.visibleChars = lastMessage.content.length;
                    }

                    isLoading.value = false;
                    controller = null;

                    if (typingInterval) {
                        clearInterval(typingInterval);
                        typingInterval = null;
                    }

                    scrollToBottom();
                }
            };

            // åœæ­¢å“åº”
            const stopResponse = () => {
                if (controller) {
                    controller.abort();
                    const lastMessage = messages.value[messages.value.length - 1];
                    lastMessage.isLoading = false;
                    lastMessage.isStreaming = false;

                    if (lastMessage.visibleChars < lastMessage.content.length) {
                        lastMessage.visibleChars = lastMessage.content.length;
                    }

                    isLoading.value = false;
                    controller = null;

                    if (typingInterval) {
                        clearInterval(typingInterval);
                        typingInterval = null;
                    }
                }
            };

            // è·¯å†µåŠŸèƒ½ç›¸å…³å‡½æ•°
            const toggleTrafficPanel = () => {
                showTrafficPanel.value = !showTrafficPanel.value;
                if (showTrafficPanel.value) {
                    nextTick(() => {
                        initTrafficMap();
                    });
                }
            };

            // åˆå§‹åŒ–åœ°å›¾
            const initTrafficMap = () => {
                if (!mapInstance.value) {
                    mapInstance.value = new AMap.Map('traffic-map-container', {
                        resizeEnable: true,
                        zoom: 11,
                        center: [116.397428, 39.90923]
                    });

                    // æ·»åŠ å®æ—¶è·¯å†µå›¾å±‚
                    trafficLayer.value = new AMap.TileLayer.Traffic({
                        zIndex: 10
                    });
                    trafficLayer.value.setMap(mapInstance.value);
                }
            };

            // è·å–è·¯çº¿çš„å®æ—¶è·¯å†µ
            const getRouteTraffic = async (origin, destination) => {
                try {
                    // æ³¨æ„ï¼šè¿™é‡Œéœ€è¦æ›¿æ¢ä¸ºæ‚¨çš„é«˜å¾·APIå¯†é’¥
                    const response = await fetch(
                        `https://restapi.amap.com/v3/direction/driving?origin=${origin}&destination=${destination}&key=9987e38d14aa093d3589f3102c562245&extensions=all`
                    );
                    const data = await response.json();

                    if (data.status === "1" && data.route) {
                        const paths = data.route.paths[0];
                        const steps = paths.steps;

                        // å¤„ç†è·¯å†µä¿¡æ¯
                        const trafficData = steps.map(step => ({
                            roadName: step.road || 'æœªçŸ¥é“è·¯',
                            distance: step.distance,
                            duration: step.duration,
                            condition: getTrafficCondition(step.tmctype),
                            tolls: step.tolls || 0,
                            tollDistance: step.tollDistance || 0
                        }));

                        trafficInfo.value = {
                            totalDistance: paths.distance,
                            totalDuration: paths.duration,
                            tolls: paths.tolls || 0,
                            steps: trafficData
                        };

                        return trafficData;
                    }
                } catch (error) {
                    console.error('è·å–è·¯å†µä¿¡æ¯å¤±è´¥:', error);
                }
            };

            // æ ¹æ®è·¯å†µç±»å‹è¿”å›æè¿°
            const getTrafficCondition = (tmctype) => {
                const conditionMap = {
                    'å¿«é€Ÿè·¯': 'ç•…é€š',
                    'ä¸»å¹²é“': 'ç¼“è¡Œ',
                    'æ¬¡å¹²é“': 'æ‹¥å µ'
                };
                return conditionMap[tmctype] || 'æœªçŸ¥';
            };

            // æ˜¾ç¤ºè·¯å†µæ¨é€é€šçŸ¥
            const showTrafficNotification = (trafficData) => {
                // æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒé€šçŸ¥
                if ("Notification" in window) {
                    if (Notification.permission === "granted") {
                        sendTrafficNotification(trafficData);
                    } else if (Notification.permission !== "denied") {
                        Notification.requestPermission().then(function (permission) {
                            if (permission === "granted") {
                                sendTrafficNotification(trafficData);
                            }
                        });
                    }
                }
            };

            // å‘é€è·¯å†µé€šçŸ¥
            const sendTrafficNotification = (trafficData) => {
                // æ‰¾å‡ºæœ€æ‹¥å µçš„è·¯æ®µ
                const congestedRoads = trafficData.filter(item => item.condition === 'æ‹¥å µ');

                if (congestedRoads.length > 0) {
                    const notification = new Notification("è·¯å†µæé†’", {
                        body: `æ£€æµ‹åˆ°${congestedRoads.length}æ®µæ‹¥å µè·¯æ®µï¼Œå»ºè®®é€‰æ‹©å…¶ä»–è·¯çº¿`,
                        icon: "data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸš—</text></svg>"
                    });

                    notification.onclick = function() {
                        showTrafficPanel.value = true;
                        window.focus();
                        this.close();
                    };
                }
            };

            // å¼€å¯å®æ—¶è·¯å†µç›‘æ§
            const startTrafficMonitoring = (origin, destination) => {
                // æ¸…é™¤ä¹‹å‰çš„ç›‘æ§
                if (trafficMonitoring.value) {
                    clearInterval(trafficMonitoring.value);
                }

                // è®¾ç½®å®šæ—¶å™¨å®šæœŸè·å–è·¯å†µä¿¡æ¯
                trafficMonitoring.value = setInterval(async () => {
                    const trafficData = await getRouteTraffic(origin, destination);
                    if (trafficData) {
                        showTrafficNotification(trafficData);
                    }
                }, 300000); // æ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
            };

            // å¤„ç†è·¯å†µæŸ¥è¯¢
            const handleTrafficQuery = async (query) => {
                // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
                const userMessage = {
                    role: 'user',
                    content: query,
                    isLoading: false,
                    visibleChars: query.length,
                    isStreaming: false
                };
                messages.value.push(userMessage);

                // æ·»åŠ åŠ©æ‰‹å›å¤
                const assistantMessage = {
                    role: 'assistant',
                    content: 'æ­£åœ¨ä¸ºæ‚¨æŸ¥è¯¢å®æ—¶è·¯å†µä¿¡æ¯...',
                    isLoading: true,
                    visibleChars: 0,
                    isStreaming: true
                };
                messages.value.push(assistantMessage);

                scrollToBottom();

                try {
                    // è¿™é‡Œåº”è¯¥è§£æç”¨æˆ·è¾“å…¥çš„èµ·ç‚¹å’Œç»ˆç‚¹
                    // ä¸ºäº†æ¼”ç¤ºï¼Œæˆ‘ä»¬ä½¿ç”¨å›ºå®šåæ ‡ï¼ˆåŒ—äº¬åˆ°ä¸Šæµ·ï¼‰
                    const origin = "116.397428,39.90923"; // åŒ—äº¬
                    const destination = "121.473701,31.230416"; // ä¸Šæµ·

                    const trafficData = await getRouteTraffic(origin, destination);

                    if (trafficData) {
                        // æ˜¾ç¤ºè·¯å†µé¢æ¿
                        showTrafficPanel.value = true;

                        // æ›´æ–°åŠ©æ‰‹æ¶ˆæ¯
                        const lastMessage = messages.value[messages.value.length - 1];
                        lastMessage.content = "å·²ä¸ºæ‚¨æŸ¥è¯¢åˆ°å®æ—¶è·¯å†µä¿¡æ¯ï¼Œè¯¦æƒ…è¯·æŸ¥çœ‹å³ä¾§è·¯å†µé¢æ¿ã€‚";
                        lastMessage.isLoading = false;
                        lastMessage.isStreaming = false;
                        lastMessage.visibleChars = lastMessage.content.length;

                        // æ˜¾ç¤ºé€šçŸ¥
                        showTrafficNotification(trafficData);

                        // å¼€å§‹ç›‘æ§è·¯å†µå˜åŒ–
                        startTrafficMonitoring(origin, destination);
                    } else {
                        const lastMessage = messages.value[messages.value.length - 1];
                        lastMessage.content = "æŠ±æ­‰ï¼Œæ— æ³•è·å–å®æ—¶è·¯å†µä¿¡æ¯ï¼Œè¯·ç¨åé‡è¯•ã€‚";
                        lastMessage.isLoading = false;
                        lastMessage.isStreaming = false;
                        lastMessage.visibleChars = lastMessage.content.length;
                    }
                } catch (error) {
                    const lastMessage = messages.value[messages.value.length - 1];
                    lastMessage.content = "æŸ¥è¯¢è·¯å†µæ—¶å‡ºç°é”™è¯¯: " + error.message;
                    lastMessage.isLoading = false;
                    lastMessage.isStreaming = false;
                    lastMessage.visibleChars = lastMessage.content.length;
                }

                scrollToBottom();
            };

            // æ¼”ç¤ºè·¯å†µæŸ¥è¯¢
            const initTrafficDemo = async () => {
                // æ˜¾ç¤ºæ¼”ç¤ºæ•°æ®
                trafficInfo.value = {
                    totalDistance: "1200000",
                    totalDuration: "43200",
                    tolls: "500",
                    steps: [
                        {
                            roadName: "äº¬æ²ªé«˜é€Ÿå…¬è·¯",
                            distance: "800000",
                            duration: "28800",
                            condition: "ç¼“è¡Œ"
                        },
                        {
                            roadName: "ä¸Šæµ·ç»•åŸé«˜é€Ÿ",
                            distance: "150000",
                            duration: "7200",
                            condition: "æ‹¥å µ"
                        },
                        {
                            roadName: "å»¶å®‰é«˜æ¶è·¯",
                            distance: "25000",
                            duration: "3600",
                            condition: "ç•…é€š"
                        }
                    ]
                };

                // åˆå§‹åŒ–åœ°å›¾
                initTrafficMap();

                // åœ¨åœ°å›¾ä¸Šæ·»åŠ è·¯çº¿æ ‡è®°
                if (mapInstance.value) {
                    // æ·»åŠ èµ·ç‚¹æ ‡è®°
                    const startMarker = new AMap.Marker({
                        position: new AMap.LngLat(116.397428, 39.90923),
                        title: 'èµ·ç‚¹ï¼šåŒ—äº¬'
                    });
                    mapInstance.value.add(startMarker);

                    // æ·»åŠ ç»ˆç‚¹æ ‡è®°
                    const endMarker = new AMap.Marker({
                        position: new AMap.LngLat(121.473701, 31.230416),
                        title: 'ç»ˆç‚¹ï¼šä¸Šæµ·'
                    });
                    mapInstance.value.add(endMarker);

                    // è®¾ç½®åœ°å›¾ä¸­å¿ƒç‚¹
                    mapInstance.value.setCenter([118.9355645, 35.569823]);
                }
            };

            // å¤©æ°”åŠŸèƒ½ç›¸å…³å‡½æ•°
            const toggleWeatherPanel = () => {
                showWeatherPanel.value = !showWeatherPanel.value;
                if (showWeatherPanel.value && !weatherInfo.value) {
                    // å¦‚æœé¢æ¿æ‰“å¼€ä¸”æ²¡æœ‰å¤©æ°”ä¿¡æ¯ï¼Œåˆ™è·å–é»˜è®¤åŸå¸‚å¤©æ°”
                    getWeatherByCity('åŒ—äº¬');
                }
            };

            // æ ¹æ®å¤©æ°”è·å–å›¾æ ‡
            const getWeatherIcon = (weather) => {
                const weatherIcons = {
                    'æ™´': 'fas fa-sun text-yellow-400',
                    'å¤šäº‘': 'fas fa-cloud text-gray-400',
                    'é˜´': 'fas fa-cloud text-gray-500',
                    'é˜µé›¨': 'fas fa-cloud-rain text-blue-400',
                    'é›·é˜µé›¨': 'fas fa-bolt text-yellow-500',
                    'å°é›¨': 'fas fa-cloud-sun-rain text-blue-400',
                    'ä¸­é›¨': 'fas fa-cloud-rain text-blue-500',
                    'å¤§é›¨': 'fas fa-cloud-showers-heavy text-blue-600',
                    'æš´é›¨': 'fas fa-cloud-showers-heavy text-blue-800',
                    'é›ª': 'fas fa-snowflake text-blue-300',
                    'é›¾': 'fas fa-smog text-gray-400',
                    'default': 'fas fa-cloud-sun'
                };

                for (const [key, icon] of Object.entries(weatherIcons)) {
                    if (weather.includes(key)) {
                        return icon;
                    }
                }
                return weatherIcons['default'];
            };

            // è·å–æŒ‡å®šåŸå¸‚çš„å¤©æ°”ä¿¡æ¯
            const getWeatherByCity = async (city) => {
                try {
                    // æ³¨æ„ï¼šè¿™é‡Œéœ€è¦æ›¿æ¢ä¸ºæ‚¨çš„é«˜å¾·APIå¯†é’¥
                    const response = await fetch(
                        `https://restapi.amap.com/v3/weather/weatherInfo?city=${encodeURIComponent(city)}&key=9987e38d14aa093d3589f3102c562245`
                    );
                    const data = await response.json();

                    if (data.status === "1" && data.lives && data.lives.length > 0) {
                        const live = data.lives[0];

                        // è·å–é¢„æŠ¥ä¿¡æ¯
                        const forecastResponse = await fetch(
                            `https://restapi.amap.com/v3/weather/weatherInfo?city=${encodeURIComponent(city)}&extensions=all&key=9987e38d14aa093d3589f3102c562245`
                        );
                        const forecastData = await forecastResponse.json();

                        let forecasts = [];
                        if (forecastData.forecasts && forecastData.forecasts.length > 0) {
                            forecasts = forecastData.forecasts[0].casts.slice(0, 4); // å–4å¤©é¢„æŠ¥
                        }

                        weatherInfo.value = {
                            city: live.city,
                            temperature: live.temperature,
                            humidity: live.humidity,
                            weather: live.weather,
                            winddirection: live.winddirection,
                            windpower: live.windpower,
                            pressure: live.pressure,
                            reporttime: live.reporttime,
                            forecasts: forecasts
                        };

                        return weatherInfo.value;
                    }
                } catch (error) {
                    console.error('è·å–å¤©æ°”ä¿¡æ¯å¤±è´¥:', error);
                }
            };

            // å¤„ç†å¤©æ°”æŸ¥è¯¢
            const handleWeatherQuery = async (query) => {
                // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
                const userMessage = {
                    role: 'user',
                    content: query,
                    isLoading: false,
                    visibleChars: query.length,
                    isStreaming: false
                };
                messages.value.push(userMessage);

                // æ·»åŠ åŠ©æ‰‹å›å¤
                const assistantMessage = {
                    role: 'assistant',
                    content: 'æ­£åœ¨ä¸ºæ‚¨æŸ¥è¯¢å¤©æ°”ä¿¡æ¯...',
                    isLoading: true,
                    visibleChars: 0,
                    isStreaming: true
                };
                messages.value.push(assistantMessage);

                scrollToBottom();

                try {
                    // è§£æç”¨æˆ·è¾“å…¥çš„åŸå¸‚å
                    let city = 'åŒ—äº¬'; // é»˜è®¤åŸå¸‚

                    // ç®€å•çš„åŸå¸‚åæå–é€»è¾‘
                    const cityKeywords = ['åŒ—äº¬', 'ä¸Šæµ·', 'å¹¿å·', 'æ·±åœ³', 'æ­å·', 'å—äº¬', 'æˆéƒ½', 'é‡åº†', 'æ­¦æ±‰', 'è¥¿å®‰'];
                    for (const keyword of cityKeywords) {
                        if (query.includes(keyword)) {
                            city = keyword;
                            break;
                        }
                    }

                    const weatherData = await getWeatherByCity(city);

                    if (weatherData) {
                        // æ˜¾ç¤ºå¤©æ°”é¢æ¿
                        showWeatherPanel.value = true;

                        // æ›´æ–°åŠ©æ‰‹æ¶ˆæ¯
                        const lastMessage = messages.value[messages.value.length - 1];
                        lastMessage.content = `å·²ä¸ºæ‚¨æŸ¥è¯¢åˆ°${city}çš„å¤©æ°”ä¿¡æ¯ï¼š${weatherData.weather}ï¼Œæ¸©åº¦${weatherData.temperature}Â°Cï¼Œè¯¦æƒ…è¯·æŸ¥çœ‹å³ä¾§å¤©æ°”é¢æ¿ã€‚`;
                        lastMessage.isLoading = false;
                        lastMessage.isStreaming = false;
                        lastMessage.visibleChars = lastMessage.content.length;
                    } else {
                        const lastMessage = messages.value[messages.value.length - 1];
                        lastMessage.content = "æŠ±æ­‰ï¼Œæ— æ³•è·å–å¤©æ°”ä¿¡æ¯ï¼Œè¯·ç¨åé‡è¯•ã€‚";
                        lastMessage.isLoading = false;
                        lastMessage.isStreaming = false;
                        lastMessage.visibleChars = lastMessage.content.length;
                    }
                } catch (error) {
                    const lastMessage = messages.value[messages.value.length - 1];
                    lastMessage.content = "æŸ¥è¯¢å¤©æ°”æ—¶å‡ºç°é”™è¯¯: " + error.message;
                    lastMessage.isLoading = false;
                    lastMessage.isStreaming = false;
                    lastMessage.visibleChars = lastMessage.content.length;
                }

                scrollToBottom();
            };

            // æ¼”ç¤ºå¤©æ°”æŸ¥è¯¢
            const initWeatherDemo = async () => {
                // æ˜¾ç¤ºæ¼”ç¤ºæ•°æ®
                weatherInfo.value = {
                    city: "åŒ—äº¬",
                    temperature: "22",
                    humidity: "65",
                    weather: "æ™´",
                    winddirection: "åŒ—",
                    windpower: "3",
                    pressure: "1013",
                    reporttime: "2023-06-15 14:00:00",
                    forecasts: [
                        {
                            date: "ä»Šå¤©",
                            dayweather: "æ™´",
                            nighttemp: "18",
                            daytemp: "28"
                        },
                        {
                            date: "æ˜å¤©",
                            dayweather: "å¤šäº‘",
                            nighttemp: "19",
                            daytemp: "27"
                        },
                        {
                            date: "åå¤©",
                            dayweather: "é˜µé›¨",
                            nighttemp: "17",
                            daytemp: "24"
                        },
                        {
                            date: "å‘¨å››",
                            dayweather: "é˜´",
                            nighttemp: "16",
                            daytemp: "23"
                        }
                    ]
                };
            };

            // åˆå§‹åŒ–
            onMounted(() => {
                // æ£€æŸ¥æš—é»‘æ¨¡å¼åå¥½
                darkMode.value = localStorage.getItem('darkMode') === 'true' ||
                    (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches);

                // æ·»åŠ æ¬¢è¿æ¶ˆæ¯
                messages.value.push({
                    role: 'assistant',
                    content: 'æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„å‡ºè¡Œç®¡å®¶å°æ™ºï¼Œå¯ä»¥å¸®æ‚¨è§„åˆ’å®Œç¾çš„æ—…è¡Œè·¯çº¿ã€‚è¯·é—®æ‚¨æƒ³å»å“ªé‡Œæ—…è¡Œï¼Ÿæœ‰ä»€ä¹ˆç‰¹åˆ«çš„éœ€æ±‚å—ï¼Ÿ',
                    isLoading: false,
                    visibleChars: 0,
                    isStreaming: false
                });

                // ç¡®ä¿æ¬¢è¿æ¶ˆæ¯å®Œå…¨å¯è§
                messages.value[0].visibleChars = messages.value[0].content.length;
                scrollToBottom();

                // èšç„¦è¾“å…¥æ¡†
                nextTick(() => {
                    textarea.value.focus();
                });
            });

            // ç›‘å¬æ¶ˆæ¯å˜åŒ–è‡ªåŠ¨æ»šåŠ¨
            watch(messages, scrollToBottom, {deep: true});

            return {
                messages,
                userInput,
                isLoading,
                darkMode,
                chatContainer,
                textarea,
                chatHistory,
                currentChatId,
                sendMessage,
                stopResponse,
                toggleDarkMode,
                adjustTextareaHeight,
                startNewConversation,
                loadChat,
                // è·¯å†µç›¸å…³è¿”å›å€¼
                showTrafficPanel,
                trafficInfo,
                toggleTrafficPanel,
                initTrafficDemo,
                // å¤©æ°”ç›¸å…³è¿”å›å€¼
                showWeatherPanel,
                weatherInfo,
                weatherCity,
                toggleWeatherPanel,
                getWeatherByCity,
                initWeatherDemo,
                getWeatherIcon
            };
        }
    }).mount('#app');
</script>
</body>
</html>
